# Архитектура MASK BROWSER

## Обзор системы

MASK BROWSER — это высоконагруженная система антидетект браузеров с полной анонимностью и распределённой архитектурой. Система спроектирована для одновременной работы с 10 000+ контейнерами-профилями и обработки 50 000+ RPS.

## Компоненты системы

### 1. Backend (ASP.NET Core 8 Web API)

**Основные модули:**
- **AuthController** — регистрация, вход, управление токенами
- **ProfileController** — создание, запуск, остановка и удаление профилей
- **AdminController** — управление пользователями, подписками, серверами
- **ServerController** — health-check и регистрация серверных нод

**Сервисы:**
- **DockerService** — управление Docker контейнерами через Docker SDK
- **LoadBalancerService** — распределение нагрузки по серверам
- **ProfileService** — бизнес-логика управления профилями
- **AuthService** — аутентификация и авторизация (JWT, Argon2)
- **CryptoPaymentService** — интеграция с CryptoBot и Bybit
- **MetricsService** — экспорт метрик для Prometheus

**Background Jobs:**
- **ContainerMonitorJob** — мониторинг состояния контейнеров
- **SessionCleanupJob** — очистка сессий и старых данных

### 2. Frontend (React + TypeScript)

**Страницы:**
- **LandingPage** — главная страница с описанием системы
- **LoginPage / RegisterPage** — аутентификация
- **DashboardPage** — управление профилями браузера
- **AdminPanel** — админ-панель для мониторинга

**Стейт-менеджмент:**
- **Zustand** — глобальное состояние приложения
- **i18next** — интернационализация (русский/английский)

### 3. Desktop (WPF + CEF)

**Основные компоненты:**
- **MainWindow** — главное окно приложения
- **CefBrowser** — интеграция Chromium Embedded Framework
- **ApiService** — взаимодействие с API
- **ProfileManager** — управление профилями локально

### 4. Infrastructure

**Сервисы:**
- **PostgreSQL** — основная БД (master-replica)
- **Redis** — кэширование и сессии
- **RabbitMQ** — очереди задач и события
- **Prometheus** — сбор метрик
- **Grafana** — визуализация метрик
- **Loki** — агрегация логов
- **Nginx** — балансировка нагрузки

## Поток данных

### Создание профиля

1. Пользователь создаёт профиль через API
2. **ProfileService** проверяет лимиты подписки
3. **LoadBalancerService** выбирает серверную ноду
4. **DockerService** создаёт Docker контейнер
5. Контейнер запускается с изолированным профилем браузера
6. Событие публикуется в RabbitMQ

### Запуск профиля

1. Пользователь запрашивает запуск профиля
2. **ProfileService** проверяет статус
3. **LoadBalancerService** выбирает ноду с минимальной нагрузкой
4. **DockerService** запускает контейнер
5. Профилю назначается порт для доступа
6. Метрики обновляются в Prometheus

### Балансировка нагрузки

1. Каждая серверная нода отправляет health-check каждые 30 секунд
2. **LoadBalancerService** учитывает:
   - Активное количество контейнеров
   - Использование CPU
   - Использование памяти
   - Время последнего health-check
3. Выбирается нода с минимальной нагрузкой

## Масштабирование

### Горизонтальное масштабирование

- API серверы могут масштабироваться горизонтально через Nginx
- Docker контейнеры распределяются по множеству серверных нод
- PostgreSQL master-replica для разделения read/write операций

### Автоматическое масштабирование

- При достижении 80% загрузки ноды автоматически создаётся новая
- Интеграция с API Cybernetics для автоматического развёртывания
- Мониторинг через Prometheus и автоматические алерты

## Безопасность

- Шифрование данных (AES-256)
- Хеширование паролей (Argon2)
- JWT токены с коротким TTL (15 минут)
- Изоляция контейнеров
- Ограничение CPU/RAM на контейнер
- TLS/SSL для всех соединений

## Мониторинг

### Метрики Prometheus

- `maskbrowser_containers_active` — количество активных контейнеров
- `maskbrowser_containers_created_total` — всего создано контейнеров
- `maskbrowser_containers_stopped_total` — всего остановлено контейнеров
- `maskbrowser_users_active` — количество активных пользователей

### Дашборды Grafana

- Загрузка серверных нод
- Количество активных контейнеров
- Использование CPU/RAM
- Логи ошибок из Loki

## Сетевая архитектура

```
┌─────────────┐
│   Client    │
│  (Browser)  │
└──────┬──────┘
       │
       ▼
┌─────────────┐
│    Nginx    │ ── Load Balancer
└──────┬──────┘
       │
   ┌───┴───┐
   │       │
   ▼       ▼
┌─────┐ ┌─────┐
│ API │ │ API │ ── API Servers
└──┬──┘ └──┬──┘
   │       │
   ▼       ▼
┌─────────────────┐
│  PostgreSQL     │ ── Database
│  Redis          │ ── Cache
│  RabbitMQ       │ ── Queue
└─────────────────┘
       │
       ▼
┌─────────────────┐
│  Server Node 1  │ ── Docker Containers
│  Server Node 2  │
│  Server Node N  │
└─────────────────┘
```

