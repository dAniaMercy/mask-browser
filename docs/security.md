# Безопасность MASK BROWSER

## Обзор

Проект использует современные методы безопасности для защиты данных пользователей и системы.

## JWT с RSA256

### Архитектура

Вместо симметричного ключа используется RSA256:
- **Приватный ключ** — хранится на сервере, используется для подписи токенов
- **Публичный ключ** — может быть опубликован, используется для проверки токенов

### Генерация ключей

RSA ключи генерируются автоматически при первом запуске:
- Приватный ключ: `./keys/rsa_private_key.pem`
- Публичный ключ: `./keys/rsa_public_key.pem`

Если ключи уже существуют, они загружаются автоматически.

### Преимущества RSA256

1. **Безопасность**: Приватный ключ никогда не покидает сервер
2. **Масштабируемость**: Публичный ключ можно распространить на все сервисы
3. **Верификация**: Токены можно проверять без доступа к приватному ключу

## Двухфакторная аутентификация (2FA/TOTP)

### Реализация

Система использует TOTP (Time-based One-Time Password) стандарт RFC 6238:
- Совместима с Google Authenticator, Microsoft Authenticator, Authy
- QR-код генерируется автоматически при включении 2FA
- Recovery codes предоставляются для восстановления доступа

### Включение 2FA

1. Пользователь запрашивает включение 2FA через API:
```http
POST /api/auth/two-factor/enable
Authorization: Bearer <token>
```

2. Сервер генерирует:
   - Secret (TOTP ключ)
   - QR-код в base64
   - 10 recovery codes

3. Пользователь сканирует QR-код в приложение-аутентификатор

### Вход с 2FA

1. Пользователь вводит email и password
2. Если 2FA включен, сервер возвращает статус 426:
```json
{
  "message": "Two-factor authentication required",
  "requires2FA": true
}
```

3. Пользователь вводит код из приложения-аутентификатора
4. Сервер проверяет TOTP код или recovery code

### Отключение 2FA

```http
POST /api/auth/two-factor/disable
Authorization: Bearer <token>
Content-Type: application/json

{
  "password": "user_password"
}
```

## Хеширование паролей

Используется **Argon2** (можно настроить через BCrypt.Net-Next):
- Автоматическая генерация соли
- Адаптивное хеширование
- Устойчивость к брутфорсу

## Шифрование данных

- **AES-256** для шифрования пользовательских данных
- Профили браузера хранятся в зашифрованном виде
- Ключи шифрования хранятся отдельно от данных

## Защита от атак

### SQL Injection
- Использование EF Core с параметризованными запросами
- Все запросы проходят через ORM

### XSS (Cross-Site Scripting)
- Валидация и санитизация всех входных данных
- CSP заголовки (можно добавить)

### CSRF (Cross-Site Request Forgery)
- Anti-forgery токены в Next.js
- SameSite cookies

### Rate Limiting
- Ограничение запросов API (100 запросов в минуту)
- Redis для хранения счетчиков

## Cloudflare WAF

Cloudflare обеспечивает дополнительную защиту:
- Блокировка SQL-инъекций на уровне сети
- Защита от XSS атак
- DDoS защита
- Bot Fight Mode

## Рекомендации

1. **Приватные ключи**: Никогда не коммитьте `rsa_private_key.pem` в репозиторий
2. **Recovery codes**: Храните recovery codes в безопасном месте
3. **Регулярное обновление**: Обновляйте зависимости безопасности
4. **Мониторинг**: Отслеживайте попытки взлома через логи
5. **Бэкап ключей**: Регулярно создавайте резервные копии RSA ключей

